<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.pe.inface.hub.service.matrl.MatrlMapper">

<!-- 공통자재분류 목록 조회 -->
<select id="getMatrlItemList" parameterType="String" resultType="MatrlVO"><![CDATA[
SELECT
        VMI.MATRL_LCTG_ID, VMI.LCTG_NM, VMI.LCTG_DESC
      , VMI.MATRL_CTG_ID, VMI.CTG_NM, VMI.CTG_DESC
      , VMI.MATRL_ITEM_ID, VMI.ITEM_NM, VMI.ITEM_DESC, VMI.ITEM_IMG
      , CASE WHEN CMI.CMPNY_ID IS NOT NULL THEN 'Y' ELSE 'N' END AS MY_ITEM_YN
      , CMI.BUY_TYPE_CD
FROM
        V_MATRL_ITEM VMI
        LEFT OUTER JOIN CMPNY_MATRL_ITEM CMI
            ON  CMI.CMPNY_ID = #{cmpnyId, jdbcType=VARCHAR}
            AND CMI.MATRL_ITEM_ID = VMI.MATRL_ITEM_ID
            AND CMI.USE_YN = 'Y'
            AND #{cmpnyId, jdbcType=VARCHAR} IS NOT NULL -- 파라미터가 없는 경우, 쿼리가 수행되지 않도록.
WHERE   1 = 1
AND     VMI.LCTG_USE_YN = 'Y'
AND     VMI.CTG_USE_YN = 'Y'
AND     VMI.USE_YN = 'Y'
ORDER BY
        VMI.LCTG_DISP_ORDR, VMI.MATRL_LCTG_ID
      , VMI.CTG_DISP_ORDR, VMI.MATRL_CTG_ID
      , VMI.DISP_ORDR, VMI.MATRL_ITEM_ID
]]></select>


<!-- 업체 자재품목 설정 -->
<update id="useMyMatrlItem" parameterType="MatrlVO"><![CDATA[
INSERT
INTO    CMPNY_MATRL_ITEM
    (
        CMPNY_ID
      , MATRL_ITEM_ID
      , BUY_TYPE_CD
      , USE_YN
      , REGPE_ID
      , REG_DTS
      , MODPE_ID
      , MOD_DTS
    )
VALUES
    (
        #{cmpnyId, jdbcType=VARCHAR}
      , #{matrlItemId, jdbcType=VARCHAR}
      , #{buyTypeCd, jdbcType=VARCHAR}
      , #{useYn, jdbcType=VARCHAR}
      , #{userId, jdbcType=VARCHAR}
      , CURRENT_TIMESTAMP
      , #{userId, jdbcType=VARCHAR}
      , CURRENT_TIMESTAMP
    )
ON CONFLICT
    (
        CMPNY_ID
      , MATRL_ITEM_ID
    )
DO UPDATE
SET     BUY_TYPE_CD = #{buyTypeCd, jdbcType=VARCHAR}
      , USE_YN = #{useYn, jdbcType=VARCHAR}
      , MODPE_ID = #{userId, jdbcType=VARCHAR}
      , MOD_DTS = CURRENT_TIMESTAMP
]]></update>


<!-- 업체 자재품목 목록 -->
<select id="getCmpnyMatrlItemList" parameterType="String" resultType="MatrlVO"><![CDATA[
SELECT
        VMI.MATRL_LCTG_ID, VMI.LCTG_NM
      , VMI.MATRL_CTG_ID, VMI.CTG_NM
      , VMI.MATRL_ITEM_ID, VMI.ITEM_NM
      , CMI.BUY_TYPE_CD, CMI.CMPNY_ID
      , (   SELECT  COUNT(*)
            FROM    CMPNY_MATRL_ITEM_CNTRT
            WHERE   CMPNY_ID = CMI.CMPNY_ID
            AND     MATRL_ITEM_ID = CMI.MATRL_ITEM_ID
            AND     BUY_TYPE_CD = '10'
            AND     CNTRT_STAT_CD = '20'
        ) AS CNTRT_CMPNY_CNT_10
      , (   SELECT  COUNT(*)
            FROM    CMPNY_MATRL_ITEM_CNTRT
            WHERE   CMPNY_ID = CMI.CMPNY_ID
            AND     MATRL_ITEM_ID = CMI.MATRL_ITEM_ID
            AND     BUY_TYPE_CD = '20'
            AND     CNTRT_STAT_CD = '20'
        ) AS CNTRT_CMPNY_CNT_20
FROM
        CMPNY_MATRL_ITEM CMI
      , V_MATRL_ITEM VMI
WHERE   1 = 1
AND     CMI.CMPNY_ID = #{cmpnyId, jdbcType=VARCHAR}
AND     CMI.USE_YN = 'Y'
AND     CMI.MATRL_ITEM_ID = VMI.MATRL_ITEM_ID
ORDER BY
        VMI.LCTG_DISP_ORDR, VMI.MATRL_LCTG_ID
      , VMI.CTG_DISP_ORDR, VMI.MATRL_CTG_ID
      , VMI.DISP_ORDR, VMI.MATRL_ITEM_ID
]]></select>


<!-- 업체 자재 목록 -->
<select id="getCmpnyMatrlList" parameterType="String" resultType="MatrlVO"><![CDATA[
SELECT
        VMI.MATRL_LCTG_ID, VMI.LCTG_NM
      , VMI.MATRL_CTG_ID, VMI.CTG_NM
      , VMI.MATRL_ITEM_ID, VMI.ITEM_NM
      , CMI.BUY_TYPE_CD, CMI.CMPNY_ID
      , M.MATRL_ID, M.MATRL_STD, M.UNIT_CD
FROM
        CMPNY_MATRL_ITEM CMI
      , V_MATRL_ITEM VMI
      , MATRL M
WHERE   1 = 1
AND     CMI.CMPNY_ID = #{cmpnyId, jdbcType=VARCHAR}
AND     CMI.USE_YN = 'Y'
AND     CMI.MATRL_ITEM_ID = VMI.MATRL_ITEM_ID
AND     CMI.MATRL_ITEM_ID = M.MATRL_ITEM_ID
ORDER BY
        VMI.LCTG_DISP_ORDR, VMI.MATRL_LCTG_ID
      , VMI.CTG_DISP_ORDR, VMI.MATRL_CTG_ID
      , VMI.DISP_ORDR, VMI.MATRL_ITEM_ID
]]></select>


<!-- 자재품목 공급업체 계약 목록 -->
<select id="getMatrlItemCntrtList" parameterType="MatrlCntrtVO" resultType="MatrlCntrtVO"><![CDATA[
SELECT
        CMI.CMPNY_ID AS SPL_CMPNY_ID
      , C.CMPNY_NM AS SPL_CMPNY_NM
      , CMIC.CMPNY_ID
      , CMIC.CNTRT_STAT_CD, CMIC.MOD_DTS
FROM
        CMPNY_MATRL_ITEM CMI
        LEFT OUTER JOIN CMPNY_MATRL_ITEM_CNTRT CMIC
            ON  CMIC.CMPNY_ID = #{cmpnyId, jdbcType=VARCHAR}
            AND CMIC.MATRL_ITEM_ID = CMI.MATRL_ITEM_ID
            AND CMIC.SPL_CMPNY_ID = CMI.CMPNY_ID
            AND CMIC.BUY_TYPE_CD = CMI.BUY_TYPE_CD
      , CMPNY C
WHERE   1 = 1
AND     CMI.MATRL_ITEM_ID = #{matrlItemId, jdbcType=VARCHAR}
AND     CMI.BUY_TYPE_CD = #{buyTypeCd, jdbcType=VARCHAR}
AND     CMI.USE_YN = 'Y'
AND     CMI.CMPNY_ID = C.CMPNY_ID
AND     C.CMPNY_TYPE_CD = '20' -- 20:자재공급업체
]]></select>


<!-- 자재품목 공급업체 계약 설정 -->
<update id="updMatrlItemCntrtStat" parameterType="MatrlCntrtVO"><![CDATA[
INSERT
INTO    CMPNY_MATRL_ITEM_CNTRT
    (
        CMPNY_ID
      , MATRL_ITEM_ID
      , SPL_CMPNY_ID
      , BUY_TYPE_CD
      , CNTRT_STAT_CD
      , REGPE_ID
      , REG_DTS
      , MODPE_ID
      , MOD_DTS
    )
VALUES
    (
        #{cmpnyId, jdbcType=VARCHAR}
      , #{matrlItemId, jdbcType=VARCHAR}
      , #{splCmpnyId, jdbcType=VARCHAR}
      , #{buyTypeCd, jdbcType=VARCHAR}
      , #{cntrtStatCd, jdbcType=VARCHAR}
      , #{userId, jdbcType=VARCHAR}
      , CURRENT_TIMESTAMP
      , #{userId, jdbcType=VARCHAR}
      , CURRENT_TIMESTAMP
    )
ON CONFLICT
    (
        CMPNY_ID
      , MATRL_ITEM_ID
      , SPL_CMPNY_ID
      , BUY_TYPE_CD
    )
DO UPDATE
SET     CNTRT_STAT_CD = #{cntrtStatCd, jdbcType=VARCHAR}
      , MODPE_ID = #{userId, jdbcType=VARCHAR}
      , MOD_DTS = CURRENT_TIMESTAMP
]]></update>


</mapper>