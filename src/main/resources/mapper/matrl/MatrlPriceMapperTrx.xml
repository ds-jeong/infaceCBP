<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.pe.inface.hub.service.matrl.mapper.MatrlPriceMapperTrx">


<!-- 업체자재단가 요청 마스터 확정처리 -->
<!-- 업체자재단가 요청 자재가격 확정처리 => 가격으로 복사도 해야함. -->


<!-- 업체자재단가 요청 마스터 등록 -->
<insert id="insertCmpnyMatrlPriceReqMst" parameterType="MatrlPriceVO"><![CDATA[
/* matrl.MatrlPriceMapperTrx.insertCmpnyMatrlPriceReqMst */
INSERT
INTO    CMPNY_MATRL_PRICE_REQ_MST
    (
        CMPNY_ID
      , SPL_CMPNY_ID
      , APL_STRT_DT
      , APL_END_DT
      , REQ_STAT_CD
      , REQ_DT
      , CONFIRM_DT
      , REMARK
      , TITLE
      , REGPE_ID
      , REG_DTS
      , MODPE_ID
      , MOD_DTS
    )
VALUES
    (
        #{cmpnyId, jdbcType=VARCHAR}
      , #{splCmpnyId, jdbcType=VARCHAR}
      , #{aplStrtDt, jdbcType=VARCHAR}
      , #{aplEndDt, jdbcType=VARCHAR}
      , #{reqStatCd, jdbcType=VARCHAR}
      , #{reqDt, jdbcType=VARCHAR}
      , #{confirmDt, jdbcType=VARCHAR}
      , #{remark, jdbcType=VARCHAR}
      , #{title, jdbcType=VARCHAR}
      , #{regpeId, jdbcType=VARCHAR}
      , CURRENT_TIMESTAMP
      , #{modpeId, jdbcType=VARCHAR}
      , CURRENT_TIMESTAMP
    )
]]></insert>


<!-- 업체자재단가 요청 마스터 수정 -->
<!-- 이전상태 조건 체크 -> 상태 변경 및 확정인 경우 확정일자 수정 -->
<update id="updateCmpnyMatrlPriceReqMst" parameterType="MatrlPriceVO"><![CDATA[
/* matrl.MatrlPriceMapperTrx.updateCmpnyMatrlPriceReqMst */
UPDATE
        CMPNY_MATRL_PRICE_REQ_MST
SET
        MODPE_ID = #{modpeId, jdbcType=VARCHAR}
      , MOD_DTS = CURRENT_TIMESTAMP
      , REQ_STAT_CD = #{reqStatCd, jdbcType=VARCHAR}
      , CONFIRM_DT = CASE WHEN #{reqStatCd, jdbcType=VARCHAR} = '20'
                        THEN TO_CHAR(CURRENT_TIMESTAMP, 'YYYYMMDD')
                        ELSE CONFIRM_DT
                     END
WHERE   1 = 1
AND     CMPNY_ID = #{cmpnyId, jdbcType=VARCHAR}
AND     SPL_CMPNY_ID = #{splCmpnyId, jdbcType=VARCHAR}
AND     APL_STRT_DT = #{aplStrtDt, jdbcType=VARCHAR}
AND     REQ_STAT_CD = #{prevReqStatCd, jdbcType=VARCHAR}
]]></update>


<!-- 업체자재단가 요청 자재가격 등록 -->
<insert id="insertCmpnyMatrlPriceReq" parameterType="MatrlPriceVO"><![CDATA[
/* matrl.MatrlPriceMapperTrx.insertCmpnyMatrlPriceReq */
INSERT
INTO    CMPNY_MATRL_PRICE_REQ
    (
        CMPNY_ID
      , SPL_CMPNY_ID
      , APL_STRT_DT
      , MATRL_ID
      , REQ_STAT_CD
      , REQ_DT
      , CONFIRM_DT
      , BUY_TYPE_CD
      , LEASE_PERD_CD
      , PRICE
      , REQ_PRICE
      , SUGST_PRICE
      , LEASE_PRICE
      , REQ_LEASE_PRICE
      , SUGST_LEASE_PRICE
      , REGPE_ID
      , REG_DTS
      , MODPE_ID
      , MOD_DTS
    )
VALUES
    (
        #{cmpnyId, jdbcType=VARCHAR}
      , #{splCmpnyId, jdbcType=VARCHAR}
      , #{aplStrtDt, jdbcType=VARCHAR}
      , #{matrlId, jdbcType=VARCHAR}
      , #{reqStatCd, jdbcType=VARCHAR}
      , #{reqDt, jdbcType=VARCHAR}
      , #{confirmDt, jdbcType=VARCHAR}
      , #{buyTypeCd, jdbcType=VARCHAR}
      , #{leasePerdCd, jdbcType=VARCHAR}
      , #{price, jdbcType=NUMERIC}
      , #{reqPrice, jdbcType=NUMERIC}
      , #{sugstPrice, jdbcType=NUMERIC}
      , #{leasePrice, jdbcType=NUMERIC}
      , #{reqLeasePrice, jdbcType=NUMERIC}
      , #{sugstLeasePrice, jdbcType=NUMERIC}
      , #{regpeId, jdbcType=VARCHAR}
      , CURRENT_TIMESTAMP
      , #{modpeId, jdbcType=VARCHAR}
      , CURRENT_TIMESTAMP
    )
]]></insert>


<!-- 업체자재단가 요청 자재가격 수정 - 요청금액. 건설업체용 -->
<update id="updateCmpnyMatrlPriceReqCmpny" parameterType="MatrlPriceVO"><![CDATA[
/* matrl.MatrlPriceMapperTrx.updateCmpnyMatrlPriceReqCmpny */
UPDATE
        CMPNY_MATRL_PRICE_REQ
SET
        MODPE_ID = #{modpeId, jdbcType=VARCHAR}
      , MOD_DTS = CURRENT_TIMESTAMP
      , REQ_PRICE = #{reqPrice, jdbcType=NUMERIC}
      , REQ_LEASE_PRICE = #{reqLeasePrice, jdbcType=NUMERIC}
WHERE   1 = 1
AND     CMPNY_ID = #{cmpnyId, jdbcType=VARCHAR}
AND     SPL_CMPNY_ID = #{splCmpnyId, jdbcType=VARCHAR}
AND     APL_STRT_DT = #{aplStrtDt, jdbcType=VARCHAR}
AND     MATRL_ID = #{matrlId, jdbcType=VARCHAR}
AND     ( REQ_PRICE <> #{reqPrice, jdbcType=NUMERIC} OR REQ_LEASE_PRICE <> #{reqLeasePrice, jdbcType=NUMERIC} )
]]></update>


<!-- 업체자재단가 요청 자재가격 수정 - 제안금액. 공급업체용 -->
<update id="updateCmpnyMatrlPriceReqSplCmpny" parameterType="MatrlPriceVO"><![CDATA[
/* matrl.MatrlPriceMapperTrx.updateCmpnyMatrlPriceReqSplCmpny */
UPDATE
        CMPNY_MATRL_PRICE_REQ
SET
        MODPE_ID = #{modpeId, jdbcType=VARCHAR}
      , MOD_DTS = CURRENT_TIMESTAMP
      , SUGST_PRICE = #{sugstPrice, jdbcType=NUMERIC}
      , SUGST_LEASE_PRICE = #{sugstLeasePrice, jdbcType=NUMERIC}
WHERE   1 = 1
AND     CMPNY_ID = #{cmpnyId, jdbcType=VARCHAR}
AND     SPL_CMPNY_ID = #{splCmpnyId, jdbcType=VARCHAR}
AND     APL_STRT_DT = #{aplStrtDt, jdbcType=VARCHAR}
AND     MATRL_ID = #{matrlId, jdbcType=VARCHAR}
AND     ( SUGST_PRICE <> #{sugstPrice, jdbcType=NUMERIC} OR SUGST_LEASE_PRICE <> #{sugstLeasePrice, jdbcType=NUMERIC} )
]]></update>


<!-- 업체자재단가 요청 자재가격목록 확정 처리 -->
<!-- 임시상태 요청가격 -> 확정가격 셋팅 -->
<update id="updateCmpnyMatrlPriceReqAllConfirm" parameterType="MatrlPriceVO"><![CDATA[
/* matrl.MatrlPriceMapperTrx.updateCmpnyMatrlPriceReqAllConfirm */
UPDATE
        CMPNY_MATRL_PRICE_REQ
SET
        MODPE_ID = #{modpeId, jdbcType=VARCHAR}
      , MOD_DTS = CURRENT_TIMESTAMP
      , REQ_STAT_CD = '20' -- 확정상태
      , CONFIRM_DT = TO_CHAR(CURRENT_TIMESTAMP, 'YYYYMMDD')
      , PRICE = SUGST_PRICE             -- 제안가격으로 확정
      , LEASE_PRICE = SUGST_LEASE_PRICE -- 제안가격으로 확정
WHERE   1 = 1
AND     CMPNY_ID = #{cmpnyId, jdbcType=VARCHAR}
AND     SPL_CMPNY_ID = #{splCmpnyId, jdbcType=VARCHAR}
AND     APL_STRT_DT = #{aplStrtDt, jdbcType=VARCHAR}
AND     REQ_STAT_CD = '10' -- 임시상태
]]></update>


<!-- 업체자재단가 요청 자재가격목록 가격테이블 이관 -->
<insert id="insertCmpnyMatrlPriceFromReqByConfirm" parameterType="MatrlPriceVO"><![CDATA[
/* matrl.MatrlPriceMapperTrx.insertCmpnyMatrlPriceFromReqByConfirm */
INSERT
INTO    CMPNY_MATRL_PRICE
    (
        CMPNY_ID
      , MATRL_ID
      , SPL_CMPNY_ID
      , APL_STRT_DT
      , APL_END_DT
      , BUY_TYPE_CD
      , LEASE_PERD_CD
      , PRICE
      , LEASE_PRICE
      , REGPE_ID
      , REG_DTS
      , MODPE_ID
      , MOD_DTS
    )
SELECT
        CMPR.CMPNY_ID
      , CMPR.MATRL_ID
      , CMPR.SPL_CMPNY_ID
      , CMPR.APL_STRT_DT
      , CMPRM.APL_END_DT
      , CMPR.BUY_TYPE_CD
      , CMPR.LEASE_PERD_CD
      , CMPR.SUGST_PRICE       -- 제안가격을 확정처리
      , CMPR.SUGST_LEASE_PRICE -- 제안가격을 확정처리
      , #{regpeId, jdbcType=VARCHAR}
      , CURRENT_TIMESTAMP
      , #{modpeId, jdbcType=VARCHAR}
      , CURRENT_TIMESTAMP
FROM
        CMPNY_MATRL_PRICE_REQ_MST CMPRM
      , CMPNY_MATRL_PRICE_REQ CMPR
WHERE   1 = 1
AND     CMPRM.CMPNY_ID = #{cmpnyId, jdbcType=VARCHAR}
AND     CMPRM.SPL_CMPNY_ID = #{splCmpnyId, jdbcType=VARCHAR}
AND     CMPRM.APL_STRT_DT = #{aplStrtDt, jdbcType=VARCHAR}
AND     CMPRM.REQ_STAT_CD = '20' -- 확정상태
AND     CMPRM.CMPNY_ID = CMPR.CMPNY_ID
AND     CMPRM.SPL_CMPNY_ID = CMPR.SPL_CMPNY_ID
AND     CMPRM.APL_STRT_DT = CMPR.APL_STRT_DT
AND     CMPR.REQ_STAT_CD = '10' -- 임시상태
]]></insert>


<!-- 업체자재단가 요청 메모 등록 -->
<insert id="insertCmpnyMatrlPriceReqMemo" parameterType="MatrlPriceVO"><![CDATA[
/* matrl.MatrlPriceMapperTrx.insertCmpnyMatrlPriceReqMemo */
INSERT
INTO    CMPNY_MATRL_PRICE_REQ_MEMO
    (
        CMPNY_ID
      , SPL_CMPNY_ID
      , APL_STRT_DT
      , MEMO_SEQ
      , MEMO_CONT
      , REGPE_ID
      , REG_DTS
      , MODPE_ID
      , MOD_DTS
    )
VALUES
    (
        #{cmpnyId, jdbcType=VARCHAR}
      , #{splCmpnyId, jdbcType=VARCHAR}
      , #{aplStrtDt, jdbcType=VARCHAR}
      , #{memoSeq, jdbcType=NUMERIC}
      , #{memoCont, jdbcType=VARCHAR}
      , #{regpeId, jdbcType=VARCHAR}
      , CURRENT_TIMESTAMP
      , #{modpeId, jdbcType=VARCHAR}
      , CURRENT_TIMESTAMP
    )
]]></insert>

</mapper>
