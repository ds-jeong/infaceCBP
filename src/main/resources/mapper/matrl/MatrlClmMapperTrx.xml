<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.inface.hub.service.matrl.mapper.MatrlClmMapperTrx">

<!-- 자재청구 등록 -->
<insert id="insertMatrlClm" parameterType="MatrlClmVO"><![CDATA[
/* matrl.MatrlClmMapperTrx.insertMatrlClm */
INSERT
INTO    MATRL_CLM
	(
	    MATRL_CLM_NO
	  , CLM_STAT_CD
	  , CLM_DT
	  , CLM_CHARGR_ID
	  , REMARK
	  , IN_ADDR_ZIPCD
	  , IN_ADDR
	  , IN_ADDR_REMARK
	  , IN_GATE_NO
	  , IN_CHARGR_NM
	  , IN_CHARGR_TEL
	  , IN_REMARK
	  , WORK_SITE_ID
	  , CMPNY_ID
      , REGPE_ID
      , REG_DTS
      , MODPE_ID
      , MOD_DTS
	)
VALUES
	 (
        #{matrlClmNo, jdbcType=VARCHAR}
      , #{clmStatCd, jdbcType=VARCHAR}
      , #{clmDt, jdbcType=VARCHAR}
      , #{clmChargrId, jdbcType=VARCHAR}
      , #{remark, jdbcType=VARCHAR}
      , #{inAddrZipcd, jdbcType=VARCHAR}
      , #{inAddr, jdbcType=VARCHAR}
      , #{inAddrRemark, jdbcType=VARCHAR}
      , #{inGateNo, jdbcType=VARCHAR}
      , #{inChargrNm, jdbcType=VARCHAR}
      , #{inChargrTel, jdbcType=VARCHAR}
      , #{inRemark, jdbcType=VARCHAR}
      , #{workSiteId, jdbcType=VARCHAR}
      , #{cmpnyId, jdbcType=VARCHAR}
      , #{userId, jdbcType=VARCHAR}
      , CURRENT_TIMESTAMP
      , #{userId, jdbcType=VARCHAR}
      , CURRENT_TIMESTAMP
	 )
]]></insert>

<!-- 자재청구 상태 수정 -->
<update id="updateMatrlClmStat" parameterType="MatrlClmVO"><![CDATA[
/* matrl.MatrlClmMapperTrx.updateMatrlClmStat */
UPDATE
        MATRL_CLM
SET
        MODPE_ID = #{userId, jdbcType=VARCHAR}
      , MOD_DTS = CURRENT_TIMESTAMP
      , CLM_STAT_CD = #{clmStatCd, jdbcType=VARCHAR}
WHERE   1 = 1
AND     MATRL_CLM_NO = #{matrlClmNo, jdbcType=VARCHAR}
]]></update>

<!-- 자재청구 정보 수정 -->
<!-- 작성중(10),수정요청(30) 및 등록자만 가능 -->
<!-- 수정불가한 항목이 있음. ex. workSiteId -->
<update id="updateMatrlClmInfo" parameterType="MatrlClmVO"><![CDATA[
/* matrl.MatrlClmMapperTrx.updateMatrlClmInfo */
UPDATE
        MATRL_CLM
SET
        MODPE_ID = #{userId, jdbcType=VARCHAR}
      , MOD_DTS = CURRENT_TIMESTAMP
      , CLM_STAT_CD = #{clmStatCd, jdbcType=VARCHAR}
      , REMARK = #{remark, jdbcType=VARCHAR}
      , IN_ADDR_ZIPCD = #{inAddrZipcd, jdbcType=VARCHAR}
      , IN_ADDR = #{inAddr, jdbcType=VARCHAR}
      , IN_ADDR_REMARK = #{inAddrRemark, jdbcType=VARCHAR}
      , IN_GATE_NO = #{inGateNo, jdbcType=VARCHAR}
      , IN_CHARGR_NM = #{inChargrNm, jdbcType=VARCHAR}
      , IN_CHARGR_TEL = #{inChargrTel, jdbcType=VARCHAR}
      , IN_REMARK = #{inRemark, jdbcType=VARCHAR}
WHERE   1 = 1
AND     MATRL_CLM_NO = #{matrlClmNo, jdbcType=VARCHAR}
AND     CLM_STAT_CD IN ( '10','30' )
AND     REGPE_ID = #{userId, jdbcType=VARCHAR}
]]></update>


<!-- 자재청구상세 등록/수정 upsert -->
<update id="upsertMatrlClmDtl" parameterType="MatrlClmVO"><![CDATA[
/* matrl.MatrlClmMapperTrx.upsertMatrlClmDtl */
INSERT
INTO    MATRL_CLM_DTL
    (
        MATRL_CLM_NO
      , MATRL_ID
      , MATRL_CLM_DTL_NO
      , CLM_DTL_STAT_CD
      , IN_HOPE_DT
      , IN_HOPE_HOUR
      , PREV_CLM_QTY
      , CLM_QTY
      , APRV_QTY
      , REMARK
      , REGPE_ID
      , REG_DTS
      , MODPE_ID
      , MOD_DTS
    )
VALUES
     (
        #{matrlClmNo, jdbcType=VARCHAR}
      , #{matrlId, jdbcType=VARCHAR}
      , #{matrlClmDtlNo, jdbcType=VARCHAR}
      , #{clmDtlStatCd, jdbcType=VARCHAR}
      , #{inHopeDt, jdbcType=VARCHAR}
      , #{inHopeHour, jdbcType=VARCHAR}
      , #{prevClmQty, jdbcType=NUMERIC}
      , #{clmQty, jdbcType=NUMERIC}
      , #{aprvQty, jdbcType=NUMERIC}
      , #{remark, jdbcType=VARCHAR}
      , #{userId, jdbcType=VARCHAR}
      , CURRENT_TIMESTAMP
      , #{userId, jdbcType=VARCHAR}
      , CURRENT_TIMESTAMP
     )
ON CONFLICT
    (
        MATRL_CLM_NO
      , MATRL_ID
    )
DO UPDATE
SET     IN_HOPE_DT = #{inHopeDt, jdbcType=VARCHAR}
      , IN_HOPE_HOUR = #{inHopeHour, jdbcType=VARCHAR}
      , CLM_QTY = #{clmQty, jdbcType=NUMERIC}
      , REMARK = #{remark, jdbcType=VARCHAR}
      , MODPE_ID = #{userId, jdbcType=VARCHAR}
      , MOD_DTS = CURRENT_TIMESTAMP
]]></update>

<!-- 자재청구상세 삭제 -->
<delete id="deleteMatrlClmDtl" parameterType="MatrlClmVO"><![CDATA[
/* matrl.MatrlClmMapperTrx.deleteMatrlClmDtl */
DELETE
FROM
        MATRL_CLM_DTL
WHERE   1 = 1
AND     MATRL_CLM_NO = #{matrlClmNo, jdbcType=VARCHAR}
AND     MATRL_ID = #{matrlId, jdbcType=VARCHAR}
]]></delete>


<!-- 자재청구승인 등록, 승인/반려인 경우만, 승인일시 등록 -->
<insert id="insertMatrlClmAprv" parameterType="MatrlClmAprvVO"><![CDATA[
/* matrl.MatrlClmMapperTrx.insertMatrlClmAprv */
INSERT
INTO    MATRL_CLM_APRV
    (
        MATRL_CLM_NO
      , APRV_SEQ
      , APRVR_ID
      , APRV_DTS
      , APRV_STAT_CD
      , REMARK
      , REGPE_ID
      , REG_DTS
      , MODPE_ID
      , MOD_DTS
    )
VALUES
     (
        #{matrlClmNo, jdbcType=VARCHAR}
      , #{aprvSeq, jdbcType=NUMERIC}
      , #{aprvrId, jdbcType=VARCHAR}
      , CASE WHEN #{aprvStatCd, jdbcType=VARCHAR} IN ('20','90') THEN CURRENT_TIMESTAMP ELSE NULL END
      , #{aprvStatCd, jdbcType=VARCHAR}
      , #{remark, jdbcType=VARCHAR}
      , #{userId, jdbcType=VARCHAR}
      , CURRENT_TIMESTAMP
      , #{userId, jdbcType=VARCHAR}
      , CURRENT_TIMESTAMP
     )
]]></insert>

<!-- 자재청구승인 상태 수정. 승인/반려인 경우만, 승인일시 업데이트 -->
<update id="updateMatrlClmAprvStat" parameterType="MatrlClmAprvVO"><![CDATA[
/* matrl.MatrlClmMapperTrx.updateMatrlClmAprvStat */
UPDATE
        MATRL_CLM_APRV
SET
        MODPE_ID = #{userId, jdbcType=VARCHAR}
      , MOD_DTS = CURRENT_TIMESTAMP
      , APRV_DTS = CASE WHEN #{aprvStatCd, jdbcType=VARCHAR} IN ('20','90') THEN CURRENT_TIMESTAMP ELSE NULL END
      , APRV_STAT_CD = #{aprvStatCd, jdbcType=VARCHAR}
      , REMARK = #{remark, jdbcType=VARCHAR}
WHERE   1 = 1
AND     MATRL_CLM_NO = #{matrlClmNo, jdbcType=VARCHAR}
AND     APRV_SEQ = #{aprvSeq, jdbcType=NUMERIC}
]]></update>

<!-- 자재청구파일 등록 -->
<insert id="insertMatrlClmFile" parameterType="MatrlClmFileVO"><![CDATA[
/* matrl.MatrlClmMapperTrx.insertMatrlClmFile */
INSERT
INTO    MATRL_CLM_FILE
    (
        MATRL_CLM_NO
      , FILE_SEQ
      , USE_YN
      , FILE_DESC
      , FILE_PATH
      , FILE_NM
      , REGPE_ID
      , REG_DTS
      , MODPE_ID
      , MOD_DTS
    )
VALUES
     (
        #{matrlClmNo, jdbcType=VARCHAR}
      , #{fileSeq, jdbcType=NUMERIC}
      , #{useYn, jdbcType=VARCHAR}
      , #{fileDesc, jdbcType=VARCHAR}
      , #{filePath, jdbcType=VARCHAR}
      , #{fileNm, jdbcType=VARCHAR}
      , #{userId, jdbcType=VARCHAR}
      , CURRENT_TIMESTAMP
      , #{userId, jdbcType=VARCHAR}
      , CURRENT_TIMESTAMP
     )
]]></insert>

</mapper>